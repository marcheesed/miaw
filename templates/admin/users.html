{% extends 'layout.html' %} {% block content %}
<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>User Management with Badges</title>
        <style>
            .dropdown {
                position: relative;
                display: inline-block;
            }
            .dropbtn {
                background: none;
                border: none;
                cursor: pointer;
                padding: 0;
            }
            .dropdown-content {
                display: none;
                position: absolute;
                background-color: #fff;
                min-width: 220px;
                box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2);
                padding: 10px;
                z-index: 1;
            }

            .dropdown:hover .dropdown-content {
                display: block;
            }

            .select-styled {
                appearance: none;
                background-color: #fff;
                border: 1px solid #ccc;
                padding: 8px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-family: Arial, sans-serif;
                font-size: 0.9em;
                transition:
                    background-color 0.3s,
                    border-color 0.3s;
            }
            .select-styled:hover {
                border-color: #888;
            }
        </style>
    </head>
    <body>
        <div class="container-1">
            <form
                method="GET"
                action="{{ url_for('users') }}"
                style="text-align: center; margin-bottom: 20px"
            >
                <input
                    type="hidden"
                    name="csrf_token"
                    value="{{ csrf_token() }}"
                />
                <input
                    type="text"
                    name="search"
                    placeholder="Search by username..."
                    value="{{ request.args.get('search', '') }}"
                    style="padding: 8px; width: 200px"
                />
                <button class="btn" type="submit" style="padding: 8px 12px">
                    Search
                </button>
            </form>

            <table
                border="1"
                cellpadding="8"
                cellspacing="0"
                style="width: 100%; margin-bottom: 20px"
            >
                <thead>
                    <tr>
                        <th>username</th>

                        <th>banned</th>
                        <th>actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in users %}
                    <tr>
                        <td>
                            <a
                                href="{{ url_for('profile', username=item.user.username) }}"
                                >{{ item.user.username }}</a
                            >
                        </td>

                        <td>
                            {% if item.banned %} yes {% else %} nah {% endif %}
                        </td>
                        <td>
                            <div style="display: flex; gap: 10px">
                                {% if item.banned %}

                                <form
                                    method="post"
                                    action="{{ url_for('unban_user', user_id=item.user.id) }}"
                                >
                                    <button class="btn" type="submit">
                                        unban
                                    </button>
                                    <input
                                        type="hidden"
                                        name="csrf_token"
                                        value="{{ csrf_token() }}"
                                    />
                                </form>
                                {% else %}
                                <form
                                    method="post"
                                    action="{{ url_for('ban_user', user_id=item.user.id) }}"
                                >
                                    <input
                                        type="hidden"
                                        name="csrf_token"
                                        value="{{ csrf_token() }}"
                                    />
                                    <input
                                        type="hidden"
                                        name="reason"
                                        value="Violation"
                                    />
                                    <button class="btn" type="submit">
                                        ban
                                    </button>
                                </form>
                                {% endif %}
                                <form
                                    method="post"
                                    action="{{ url_for('ban_ip') }}"
                                >
                                    <input
                                        type="hidden"
                                        name="csrf_token"
                                        value="{{ csrf_token() }}"
                                    />
                                    <input
                                        type="hidden"
                                        name="ip_address"
                                        value="{{ item.user.ip_address }}"
                                    />
                                    <button class="btn" type="submit">
                                        ban ip
                                    </button>
                                </form>
                                <form
                                    method="post"
                                    action="{{ url_for('delete_user', user_id=item.user.id) }}"
                                    onsubmit="
                                        return confirm(
                                            'Are you sure you want to delete this user?',
                                        );
                                    "
                                >
                                    <button class="btn" type="submit">
                                        delete
                                    </button>
                                </form>
                            </div>
                            <form
                                method="POST"
                                id="assign-form-{{ item.user.id }}"
                                onsubmit="
                                    return confirm(
                                        'Are you sure you want to assign this badge to this user?',
                                    );
                                "
                            >
                                <div
                                    class="dropdown"
                                    style="
                                        margin-top: 10px;
                                        position: relative;
                                        display: inline-block;
                                    "
                                >
                                    <button
                                        type="button"
                                        class="btn"
                                        onclick="toggleDropdown({{ item.user.id }})"
                                    >
                                        assign badge
                                    </button>
                                    <input
                                        type="hidden"
                                        name="csrf_token"
                                        value="{{ csrf_token() }}"
                                    />

                                    <div
                                        class="dropdown-content"
                                        id="dropdown-content-{{ item.user.id }}"
                                    >
                                        {% for badge in badges %}
                                        <div
                                            class="dropdown-item"
                                            style="
                                                padding: 8px;
                                                cursor: pointer;
                                            "
                                            onclick="toggleBadge({{ item.user.id }}, '{{ badge.id }}', {{ 'true' if badge.id in item.user.badges else 'false' }})"
                                        >
                                            {{ badge.name }}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Hidden input to store selected badge -->
                                <input
                                    type="hidden"
                                    id="badge-input-{{ item.user.id }}"
                                    name="badge"
                                />
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- Pagination -->
        <div class="pagination" style="text-align: center">
            {% if page > 1 %}
            <a href="{{ url_for('users', page=page-1) }}">Previous</a>
            {% else %}
            <a class="disabled">Previous</a>
            {% endif %}
            <span>Page {{ page }} of {{ total_pages }}</span>
            {% if page < total_pages %}
            <a href="{{ url_for('users', page=page+1) }}">Next</a>
            {% else %}
            <a class="disabled">Next</a>
            {% endif %}
        </div>

        <script>
            function submitAssignBadge(userId) {
                const urlTemplate =
                    '{{ url_for("assign_badge", user_id=0, badge_id=0) }}';
                const url = urlTemplate
                    .replace("/0/", "/" + userId + "/")
                    .replace(
                        "/0",
                        "/" +
                            document.getElementById("badge_select_" + userId)
                                .value,
                    );
                const form = document.getElementById("assign-form-" + userId);
                form.action = url;
                form.submit();
            }
        </script>
        <script>
            function removeBadge(userId, badgeId) {
                fetch(
                    `{{ url_for('remove_badge', user_id=0, badge_id=0) }}`
                        .replace("/0/", "/" + userId + "/")
                        .replace("/0", "/" + badgeId),
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                            "X-CSRFToken": "{{ csrf_token() }}",
                        },
                    },
                ).then((response) => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert("Failed to remove badge.");
                    }
                });
            }

            function toggleDropdown(userId) {
                const menu = document.getElementById(
                    "dropdown-content-" + userId,
                );
                if (menu.style.display === "block") {
                    menu.style.display = "none";
                } else {
                    menu.style.display = "block";
                }
            }

            function selectBadge(userId, badgeId) {
                document.getElementById("badge-input-" + userId).value =
                    badgeId;
                submitAssignBadge(userId);
                document.getElementById(
                    "dropdown-content-" + userId,
                ).style.display = "none";
            }

            function submitAssignBadge(userId) {
                const form = document.getElementById("assign-form-" + userId);
                const badgeId = document.getElementById(
                    "badge-input-" + userId,
                ).value;
                const urlTemplate =
                    '{{ url_for("assign_badge", user_id=0, badge_id=0) }}';
                const url = urlTemplate
                    .replace("/0/", "/" + userId + "/")
                    .replace("/0", "/" + badgeId);
                form.action = url;
                form.submit();
            }
        </script>
    </body>
</html>
{% endblock %}
