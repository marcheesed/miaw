{% extends "layout.html" %} {% block content %}
<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
    </head>
    <body>
        <div class="container-1">
            <form
                method="POST"
                action="{{ url_for('edit_paste', paste_id=paste.id) }}"
            >
                <input
                    type="hidden"
                    name="csrf_token"
                    value="{{ csrf_token() }}"
                />
                <label for="content">content</label><br />
                <textarea
                    id="content"
                    name="content"
                    rows="20"
                    cols="80"
                    required
                >
{{ paste.content }}</textarea
                ><br /><br />
            <div class="flexy-wexy">

                    <button class="btn" type="submit">save changes</button>
                </form>

                {% if current_user or (current_user and (current_user.id ==
                paste.user_id or current_user.is_admin)) %}

                <form
                    method="POST"
                    action="{{ url_for('transfer_ownership', paste_id=paste.id) }}"
                    id="transferOwnershipForm"
                    style="display:flex;gap:10px; align-items:center; justify-content: flex-end"
                >
                    <input
                        type="hidden"
                        name="csrf_token"
                        value="{{ csrf_token() }}"
                    />

                    <input
                        type="text"
                        id="new_owner"
                        name="new_owner"
                        placeholder="username"
                    />
                    <button class="btn" type="submit">
                        transfer ownership
                    </button>
                </form>
                {% endif %}
            </div>

            <br />
            <div style="display:flex; justify-content: space-between">
            <a href="{{ url_for('view_paste', paste_id=paste.id) }}"><button class="btn">cancel</button></a>

            <form
                method="POST"
                action="{{ url_for('delete_paste', paste_id=paste.id) }}"
                onsubmit="
                    return confirm(
                        'are you sure you want to delete this paste?',
                    );
                "
            >
                <input
                    type="hidden"
                    name="csrf_token"
                    value="{{ csrf_token() }}"
                />
                <button class="btn" type="submit">delete paste</button>
            </form>
            </div>
        </div>
        <div
            id="popup"
            style="
                display: none;
                position: fixed;
                top: 20%;
                left: 50%;
                transform: translateX(-50%);
                z-index: 1000;
            "
        >
            <span id="popup-message"></span>
            <br />
            <button onclick="hidePopup()">Close</button>
        </div>

        <script>
            function showPopup(message) {
                document.getElementById("popup-message").innerText = message;
                document.getElementById("popup").style.display = "block";
            }

            function hidePopup() {
                document.getElementById("popup").style.display = "none";
            }

            const transferForm = document.getElementById(
                "transferOwnershipForm",
            );
            if (transferForm) {
                transferForm.addEventListener("submit", function (e) {
                    e.preventDefault();

                    fetch(this.action, {
                        method: "POST",
                        body: new FormData(this),
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.success) {
                                alert("ownership transferred successfully!");
                                location.reload();
                            } else {
                                showPopup(data.error);
                            }
                        })
                        .catch((error) => {
                            showPopup("an error occurred.");
                            console.error("Error:", error);
                        });
                });
            }
        </script>
        {% endblock %}
    </body>
</html>
